#!/usr/bin/env zsh

# Dictation script using OpenAI Whisper
# Dependencies: arecord, whisper (openai-whisper), xdotool, notify-send, pactl, jq

PID_FILE="/tmp/dictate-whisper.pid"
NID_FILE="/tmp/dictate-whisper.nid"
AUDIO_FILE="/tmp/dictate-whisper.wav"
OUTPUT_BASE="/tmp/dictate-whisper"
# Whisper adds extensions automatically, so we'll look for .txt
OUTPUT_FILE="${OUTPUT_BASE}.txt"

# Configuration
MODEL="small.en"
# Prompt to help Whisper understand coding context and grammar
INITIAL_PROMPT="Hello, I am a programmer. I will be dictating code. Expect terms like: function, class, const, let, var, import, export, return, if, else, for, while, switch, case, break, continue, true, false, null, undefined, NaN, Infinity, void, any, string, number, boolean, Array, Object, Promise, async, await, try, catch, throw, new, this, super, extends, implements, interface, type, module, namespace, package, public, private, protected, static, readonly, abstract, get, set, slash, dot, underscore, camelCase, snake_case, PascalCase, kebab-case, /path/to/file, index.ts, main.rs, app.jsx, styles.css. Please use proper punctuation and spacing. For example: Hello, world. This is a test."

notify() {
    # Usage: notify <icon> <summary> <bodyy> [replace_id]
    local icon="$1"
    local summary="$2"
    local body="$3"
    local replace_id="$4"

    if [[ -n "$replace_id" ]]; then
        notify-send -i "$icon" -u low -t 2000 -r "$replace_id" -p "$summary" "$body"
    else
        notify-send -i "$icon" -u low -t 2000 -p "$summary" "$body"
    fi
}

setup_audio() {
    # 1. Dynamic Bluetooth Headset Detection
    # Find any card that uses the bluez5 device driver
    CARD_NAME=$(pactl -f json list cards | jq -r '.[] | select(.driver == "module-bluez5-device.c") | .name' | head -n 1)

    SOURCE_NAME=""

    if [[ -n "$CARD_NAME" ]]; then
        # Headset found, check profile
        ACTIVE_PROFILE=$(pactl -f json list cards | jq -r --arg CARD_NAME "$CARD_NAME" '.[] | select(.name == $CARD_NAME) | .active_profile')

        if [[ "$ACTIVE_PROFILE" != "headset-head-unit" ]]; then
            pactl set-card-profile "$CARD_NAME" headset-head-unit
            # Give it a moment to switch
            sleep 1
        fi

        # Find the source name for the headset
        # Usually ends in .headset-head-unit
        SOURCE_NAME=$(pactl list sources short | grep "$CARD_NAME" | grep "headset-head-unit" | awk '{print $2}' | head -n 1)
    fi

    # Fallback to default source if headset not found or failed
    if [[ -z "$SOURCE_NAME" ]]; then
        SOURCE_NAME=$(pactl get-default-source)
    fi

    # 2. Setup Noise Cancellation
    # Check if module already loaded for this source
    # We use a unique name for our noise cancelled source to avoid conflicts
    NC_SOURCE="whisper_noise_cancelled"

    # Unload existing module if it exists (to ensure we attach to the right source)
    EXISTING_MODULE=$(pactl list modules short | grep "source_name=$NC_SOURCE" | awk '{print $1}')
    if [[ -n "$EXISTING_MODULE" ]]; then
        pactl unload-module "$EXISTING_MODULE"
    fi

    # Load module
    pactl load-module module-echo-cancel aec_method=webrtc source_master="$SOURCE_NAME" source_name="$NC_SOURCE" > /dev/null 2>&1

    echo "$NC_SOURCE"
}

if [[ -f "$PID_FILE" ]]; then
    # Stop recording
    PID=$(cat "$PID_FILE")
    if ps -p "$PID" > /dev/null; then
        kill "$PID"
    fi
    rm -f "$PID_FILE"

    # Get previous notification ID
    REPLACE_ID=""
    if [[ -f "$NID_FILE" ]]; then
        REPLACE_ID=$(cat "$NID_FILE")
        rm -f "$NID_FILE"
    fi

    # Update notification to "Transcribing..."
    TRANS_NID=$(notify-send -i "microphone-sensitivity-muted-symbolic" -u low -t 0 -r "$REPLACE_ID" -p "Whisper" "Transcribing...")

    # Transcribe
    # whisper "$AUDIO_FILE" --model "$MODEL" --initial_prompt "$INITIAL_PROMPT" --output_format txt --output_dir /tmp --fp16 False > /dev/null 2>&1

    # Use faster-whisper helper script
    ~/.venvs/faster-whisper/bin/python ~/.config/bin/dictate-process.py "$AUDIO_FILE" --model "$MODEL" --initial_prompt "$INITIAL_PROMPT" --output_file "$OUTPUT_FILE" > /dev/null 2>&1

    if [[ -f "$OUTPUT_FILE" ]]; then
        TEXT=$(cat "$OUTPUT_FILE")

        if [[ -n "$TEXT" ]]; then
            # Trim leading/trailing whitespace and newlines
            TEXT=$(echo "$TEXT" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

            # Check again if text is not empty after trimming
            if [[ -n "$TEXT" ]]; then
                xdotool type --clearmodifiers --delay 10 "$TEXT"
                notify-send -i "emblem-default" -u low -t 2000 -r "$TRANS_NID" "Whisper" "Done."
            else
                 notify-send -i "dialog-error" -u low -t 2000 -r "$TRANS_NID" "Whisper" "No text detected."
            fi
        else
            notify-send -i "dialog-error" -u low -t 2000 -r "$TRANS_NID" "Whisper" "No text detected."
        fi
        rm -f "$OUTPUT_FILE"
    else
        notify-send -i "dialog-error" -u low -t 2000 -r "$TRANS_NID" "Whisper" "Transcription failed."
    fi

    rm -f "$AUDIO_FILE"

    # Optional: Switch headset back to A2DP?
    # User didn't explicitly ask to switch back, but it's good practice.
    # However, they might want to continue dictating. Let's leave it for now.

else
    # Start recording

    # Send initial notification
    NID=$(notify-send -i "audio-input-microphone-high-symbolic" -u low -t 0 -p "Whisper" "Setting up audio...")
    echo "$NID" > "$NID_FILE"

    # Setup Audio
    REC_SOURCE=$(setup_audio)

    # Update notification
    notify-send -i "audio-input-microphone-high-symbolic" -u low -t 0 -r "$NID" "Whisper" "Listening..."

    # Record from the noise cancelled source
    # Using parecord is safer for PulseAudio sources.
    if command -v parecord >/dev/null 2>&1; then
        parecord --device="$REC_SOURCE" --format=s16le --rate=16000 --channels=1 "$AUDIO_FILE" > /dev/null 2>&1 &
    else
        # Fallback to arecord, hoping default source was set correctly or just use default
        # We can try setting default source
        pactl set-default-source "$REC_SOURCE"
        arecord -f cd "$AUDIO_FILE" > /dev/null 2>&1 &
    fi

    PID=$!
    echo $PID > "$PID_FILE"
fi
