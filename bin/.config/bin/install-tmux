#!/usr/bin/env zsh

# Install latest tmux from source
# See: https://github.com/tmux/tmux

# Use global gum_style command for styling

# Parse arguments
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "Usage: $0 [-n|--next] [-h|--help]"
    echo ""
    echo "Install the latest tmux from source to /usr/local/bin."
    echo ""
    echo "Options:"
    echo "  -n, --next    Install the latest pre-release (next) version instead of stable."
    echo "  -h, --help    Show this help message."
    echo ""
    echo "Examples:"
    echo "  $0              # Install latest stable tmux"
    echo "  $0 -n           # Install latest next version"
    echo "  $0 --next       # Install latest next version"
    echo "  $0 --help       # Show this help"
    exit 0
fi

next=false
if [[ "$1" == "--next" || "$1" == "-n" ]]; then
    next=true
fi

# Save current dir
# pushd . >/dev/null || exit

# Detect OS and install dependencies
detect_and_install_deps() {
    local cache_file="$HOME/.cache/tmux-deps-installed"
    if [[ -f "$cache_file" ]]; then
        command gum_style "Dependencies already installed (cached)" "" "" ""
        return
    fi

    command gum_style 'Detecting OS and installing dependencies...' "" "" ""

    if [[ "$(uname -s)" == "Darwin" ]]; then
        # macOS
        if ! command -v brew >/dev/null 2>&1; then
            command gum_style "❌ Homebrew not found. Please install Homebrew first: https://brew.sh/" "" "" ""
            exit 1
        fi
        brew install libevent ncurses pkg-config bison autoconf automake git
    elif command -v apt >/dev/null 2>&1; then
        # Debian/Ubuntu
        sudo apt update
        sudo apt install -y libevent-dev libncurses-dev build-essential pkg-config bison autoconf automake git
    elif command -v dnf >/dev/null 2>&1; then
        # Fedora/RHEL
        sudo dnf install -y libevent-devel ncurses-devel gcc make pkgconfig bison autoconf automake git
    elif command -v pacman >/dev/null 2>&1; then
        # Arch
        sudo pacman -S --noconfirm libevent ncurses gcc make pkg-config bison autoconf automake git
    else
        command gum_style "❌ Unsupported OS. Please install dependencies manually: libevent, ncurses, build tools, pkg-config, bison, autoconf, automake, git" "" "" ""
        exit 1
    fi

    mkdir -p "$(dirname "$cache_file")"
    touch "$cache_file"
}

# Get current installed tmux version
get_current_version() {
    if command -v tmux >/dev/null 2>&1; then
        tmux -V | awk '{print $2}' | tr -d '\n'
    else
        echo "none"
    fi
}

# Get latest tmux version
get_latest_version() {
    if $next; then
        echo "next"
    else
        git ls-remote --tags https://github.com/tmux/tmux.git 2>/dev/null | grep -v 'next' | sed 's|.*refs/tags/||' | sort -V | tail -1 | tr -d '\n'
    fi
}

# Main execution
detect_and_install_deps

current_version=$(get_current_version)
latest_version=$(get_latest_version)

    if ! $next && [[ "$current_version" == "$latest_version" ]]; then
        command gum_style "tmux is already the latest stable version ($latest_version)" "" "" ""
        exit 0
    fi

    if $next; then
        version_desc="next version"
    else
        version_desc="$latest_version"
    fi
    command gum_style "Installing tmux $version_desc (current: $current_version)..." "" "" ""

# Setup tmux directory
TMUX_DIR="$HOME/Projects/Personal/Github/tmux"
    if ! mkdir -p "$(dirname "$TMUX_DIR")"; then
        command gum_style "❌ Error: Could not create parent directory for tmux" "" "" ""
        exit 1
    fi

    if ! cd "$(dirname "$TMUX_DIR")"; then
        command gum_style "❌ Error: Could not navigate to $(dirname "$TMUX_DIR")" "" "" ""
        exit 1
    fi

    if [[ ! -d "$TMUX_DIR" ]] || [[ ! -d "$TMUX_DIR/.git" ]]; then
        command gum_style "Cloning tmux repository..." "" "" ""
        rm -rf "$TMUX_DIR"
        if ! git clone https://github.com/tmux/tmux "$TMUX_DIR"; then
            command gum_style "❌ Error: Failed to clone tmux repository" "" "" ""
            exit 1
        fi
    else
        if ! cd tmux; then
            command gum_style "❌ Error: Could not navigate to tmux directory" "" "" ""
            exit 1
        fi
        command gum_style "Updating tmux repo..." "" "" ""
        if ! git pull origin master; then
            command gum_style "⚠️ Warning: Failed to update tmux repo, continuing with existing version" "" "" ""
        fi
    fi

    if ! cd "$TMUX_DIR"; then
        exit 1
    fi

    # Checkout the specific version for stable, stay on master for next
    if ! $next; then
        if ! git checkout "$latest_version"; then
            command gum_style "❌ Error: Failed to checkout $latest_version" "" "" ""
            exit 1
        fi
    fi

    command gum_style "Building tmux $version_desc..." "" "" ""
    if ! sh autogen.sh; then
        command gum_style "❌ Error: autogen.sh failed" "" "" ""
        exit 1
    fi

    if ! ./configure --prefix=/usr/local; then
        command gum_style "❌ Error: configure failed" "" "" ""
        exit 1
    fi

    if ! make; then
        command gum_style "❌ Error: make failed" "" "" ""
        exit 1
    fi

    command gum_style "Installing tmux..." "" "" ""
    if ! sudo make install; then
        command gum_style "❌ Error: make install failed" "" "" ""
        exit 1
    fi

    # Verify
    if command -v /usr/local/bin/tmux >/dev/null 2>&1; then
        command gum_style "✅ tmux $version_desc installed successfully at /usr/local/bin/tmux" "" "" ""
    else
        command gum_style "❌ Error: tmux not found after install" "" "" ""
        exit 1
    fi

# Restore dir
# popd >/dev/null</content>
<parameter name="filePath">bin/.config/bin/install-tmux
