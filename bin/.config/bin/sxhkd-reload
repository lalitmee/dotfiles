#!/usr/bin/env bash
# More robust sxhkd reload script
# Sends USR1 signal to reload config, and restarts if it crashes.

sxhkd_pid=$(pgrep -x sxhkd)

if [ -n "$sxhkd_pid" ]; then
    # sxhkd is running, attempt to reload.
    kill -USR1 "$sxhkd_pid"

    # Poll for a short duration to see if the process dies.
    # We'''ll check 5 times over 0.5 seconds.
    crashed=false
    for _ in {1..5}; do
        if ! ps -p "$sxhkd_pid" > /dev/null; then
            crashed=true
            break
        fi
        sleep 0.1
    done

    if [ "$crashed" = true ]; then
        notify-send -u critical "sxhkd" "Crashed on reload, restarting..."
        sxhkd &
        # After attempting restart, check if it'''s actually running now.
        sleep 0.1 # Give it a moment to start
        if ! pgrep -x sxhkd > /dev/null; then
             notify-send -u critical "sxhkd" "FATAL: Failed to restart. Check sxhkdrc."
        else
             disown
        fi
    else
        notify-send -u normal "sxhkd" "Keybindings reloaded successfully"
    fi
else
    # sxhkd process was not found, so start it.
    notify-send -u critical "sxhkd" "sxhkd not running, starting it..."
    sxhkd &
    disown
fi