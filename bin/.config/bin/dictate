#!/bin/bash
# Wrapper script to toggle nerd-dictation

PID_FILE="/tmp/nerd-dictation.pid"
VENV_PYTHON="$HOME/.venvs/nerd-dictation/bin/python"
NERD_DICTATION_SCRIPT="$HOME/.local/bin/nerd-dictation"

# Updated notify function to accept an icon name
notify() {
    # Usage: notify <icon> <summary> <body>
    notify-send -i "$1" -u low -t 2000 "$2" "$3"
}

# Check if the process is still running, otherwise clean up PID file
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if ! ps -p "$PID" > /dev/null; then
        # Process is not running, remove stale PID file
        rm -f "$PID_FILE"
    fi
fi

if [ -f "$PID_FILE" ]; then
    # PID file exists, so the process should be running. Tell it to end.
    "$VENV_PYTHON" "$NERD_DICTATION_SCRIPT" end
    rm -f "$PID_FILE"
    # Use a "muted" icon for the stopped state
    notify "microphone-sensitivity-muted-symbolic" "Speech To Text" "Not listening now..."
else
    # PID file does not exist. Start the process.
    # The script will run in the background.
    # We set a very long pause duration to achieve 'indefinite' listening.
    # Use a standard microphone icon for the started state
    nohup "$VENV_PYTHON" "$NERD_DICTATION_SCRIPT" begin --vosk-model-dir="$HOME/.local/share/vosk/model-en-in" &> /tmp/nerd-dictation.log &
    notify "audio-input-microphone-high-symbolic" "Speech to Text" "Listening now..."
    echo $! > "$PID_FILE"
fi
