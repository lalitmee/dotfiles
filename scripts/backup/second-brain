#!/bin/bash

PERSONAL_BRAIN_DIR="$HOME/Projects/Personal/Github/second-brain"
WORK_BRAIN_DIR="$HOME/Projects/Work/Github/second-brain"

BRAIN="$1" # expects 'personal' or 'work'

if [[ "$BRAIN" != "personal" && "$BRAIN" != "work" ]]; then
  echo "‚ùå ERROR: Please specify 'personal' or 'work' as the first argument"
  exit 1
fi

if [[ "$BRAIN" == "personal" ]]; then
  TARGET_DIR="$PERSONAL_BRAIN_DIR"
elif [[ "$BRAIN" == "work" ]]; then
  TARGET_DIR="$WORK_BRAIN_DIR"
fi

echo "------------------------------------------------------------"
echo "üß† $BRAIN backup started at: $(date '+%Y-%m-%d %H:%M:%S')"
echo "üîç USER: $(whoami) | HOSTNAME: $(hostname) | DIR: $TARGET_DIR"

# 1. Try to cd into the brain directory
if ! cd "$TARGET_DIR" 2>/dev/null; then
  echo "‚ùå ERROR: Failed to cd into $TARGET_DIR"
  exit 1
fi

# 2. Pull latest changes
if ! git pull --rebase 2>&1 | tee /tmp/git-pull-$BRAIN.log | grep -qv "fatal:"; then
  echo "‚ùå ERROR: Git pull failed"
  cat /tmp/git-pull-$BRAIN.log
  exit 1
fi

# 3. Only commit and push if there are actual changes
if ! git diff --quiet || ! git diff --cached --quiet; then
  git add .

  if git commit -m "auto: $BRAIN backup on $(date '+%Y-%m-%d %H:%M:%S')" >/dev/null 2>&1; then
    if git push >/dev/null 2>&1; then
      echo "‚úÖ $BRAIN backup committed and pushed"
    else
      echo "‚ùå ERROR: Git push failed for $BRAIN"
    fi
  else
    echo "‚ùå ERROR: Git commit failed for $BRAIN"
  fi
else
  echo "‚úÖ No changes to commit in $BRAIN brain"
fi
