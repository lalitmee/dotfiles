#!/usr/bin/env zsh

# Toggle wrapper for davabase whisper_real_time test implementation
# Usage: ./whisper-toggle.sh [--model=base] [--microphone=pulse]

# Default settings
MODEL="base"
MICROPHONE="pulse"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --model=*)
            MODEL="${1#*=}"
            shift
            ;;
        --microphone=*)
            MICROPHONE="${1#*=}"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--model=base|small|medium|large] [--microphone=name]"
            exit 1
            ;;
    esac
done

# Paths
SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]:-$0}")")"
PID_FILE="/tmp/whisper-davabase.pid"
LOG_FILE="/tmp/whisper-davabase.log"

# Check if virtual environment exists
VENV_DIR="$HOME/.venvs/whisper"
if [[ ! -f "$VENV_DIR/bin/activate" ]]; then
    echo "❌ Virtual environment not found. Expected at $VENV_DIR"
    exit 1
fi

# Check if already running
if [[ -f "$PID_FILE" ]]; then
    # Stop the process
    if kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        kill "$(cat "$PID_FILE")"
        rm -f "$PID_FILE"
        notify-send -u normal "Whisper Test" "🎤 Davabase transcription stopped"
        echo "✅ Stopped davabase whisper transcription"
    else
        # Process died, clean up
        rm -f "$PID_FILE"
        notify-send -u normal "Whisper Test" "🎤 Davabase was not running"
        echo "ℹ️  Davabase whisper was not running"
    fi
else
    # Start the process
    notify-send -u normal "Whisper Test" "🎤 Starting davabase transcription... (Model: $MODEL)"

    echo "Starting davabase whisper transcription..." > "$LOG_FILE"
    echo "Model: $MODEL, Microphone: $MICROPHONE" >> "$LOG_FILE"
    echo "Started at $(date)" >> "$LOG_FILE"

    # Start in background with virtual environment
    cd "$SCRIPT_DIR"
    nohup "$VENV_DIR/bin/python" "$SCRIPT_DIR/transcribe-demo" --model "$MODEL" --default_microphone "$MICROPHONE" >> "$LOG_FILE" 2>&1 &
    PYTHON_PID=$!

    echo $PYTHON_PID > "$PID_FILE"
    echo "Started with PID: $PYTHON_PID" >> "$LOG_FILE"

    # Wait a moment and verify it's running
    sleep 2
    if kill -0 "$PYTHON_PID" 2>/dev/null; then
        notify-send -u normal "Whisper Test" "🎤 Davabase transcription active! Speak into microphone..."
        echo "✅ Started davabase whisper transcription (PID: $PYTHON_PID)"
    else
        notify-send -u critical "Whisper Test" "❌ Failed to start davabase transcription"
        rm -f "$PID_FILE"
        echo "❌ Failed to start davabase whisper transcription"
        echo "Check logs: $LOG_FILE"
    fi
fi