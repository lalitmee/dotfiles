#!/usr/bin/env zsh

# Function to send notifications
notify_status() {
    notify-send -u normal "Whisper" "$1"
}

notify_error() {
    notify-send -u critical "Whisper Error" "$1"
}

# Log file in the dotfiles directory
DEBUG_LOG="/home/lalitmee/dotfiles/whisper_debug.log"
echo "---" >> "$DEBUG_LOG"
echo "Whisper script triggered at $(date)" >> "$DEBUG_LOG"

# Venv Python
VENV_PYTHON="$HOME/.venvs/whisper/bin/python"
if [[ ! -x "$VENV_PYTHON" ]]; then
    echo "FATAL: Python venv not found at $VENV_PYTHON" >> "$DEBUG_LOG"
    notify_error "Whisper venv not found."
    exit 1
fi

# PID file
PYTHON_PID_FILE="/tmp/whisper.pid"

# --- Main Logic ---
if [[ -f "$PYTHON_PID_FILE" ]]; then
    # --- STOP LOGIC ---
    echo "Stop command received." >> "$DEBUG_LOG"
    PYTHON_PID=$(cat "$PYTHON_PID_FILE")
    if kill -0 "$PYTHON_PID" 2>/dev/null; then
        kill "$PYTHON_PID"
        echo "Stopped Python process (PID: $PYTHON_PID)." >> "$DEBUG_LOG"
        notify_status "ðŸŽ¤ Whisper dictation stopped."
    else
        echo "Python process (PID: $PYTHON_PID) was already stopped." >> "$DEBUG_LOG"
        notify_status "ðŸŽ¤ Whisper was not running."
    fi
    rm -f "$PYTHON_PID_FILE"
else
    # --- START LOGIC ---
    echo "Start command received." >> "$DEBUG_LOG"

    SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]:-$0}")")"
    PYTHON_SCRIPT="$SCRIPT_DIR/transcribe-demo"
    
    # For now, hardcode the arguments for maximum stability
    ARGS=("--model" "base" "--energy_threshold" "500" "--default_microphone" "pulse")

    echo "Starting: $VENV_PYTHON -u $PYTHON_SCRIPT ${ARGS[@]}" >> "$DEBUG_LOG"

    # Start Python transcription
    "$VENV_PYTHON" -u "$PYTHON_SCRIPT" "${ARGS[@]}" >> "$DEBUG_LOG" 2>&1 &
    PYTHON_PID=$!
    echo $PYTHON_PID > "$PYTHON_PID_FILE"
    echo "Python process started with PID: $PYTHON_PID" >> "$DEBUG_LOG"

    sleep 2

    if kill -0 "$PYTHON_PID" 2>/dev/null; then
        notify_status "ðŸŽ¤ Whisper dictation active!"
        echo "âœ“ Whisper dictation started successfully." >> "$DEBUG_LOG"
    else
        notify_error "Failed to start Whisper dictation. Check logs."
        echo "ERROR: Process died within 2 seconds." >> "$DEBUG_LOG"
        rm -f "$PYTHON_PID_FILE"
        exit 1
    fi
fi
echo "Whisper script finished at $(date)" >> "$DEBUG_LOG"
